name: Generate requirements.txt from Pipfile
on:
  push:
    paths:
      - '**Pipfile'
      - '**Pipfile.lock'
  workflow_run:
    workflows: [Run Tests]
    types:
      - requested
  workflow_dispatch: {}

jobs:

  generate:
    name: Generate requirements
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master

    - name: Generate server requirements
      run: cd server/ && pipenv requirements

    - name: Generate seismic_webviz requirements
      run: cd seismic_webviz/ && pipenv requirements

    - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add requirements.txt
          git commit -m "Auto update requirements.txt"

    - name: Push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git push origin HEAD:${{ github.ref }}
